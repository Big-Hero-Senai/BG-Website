// üìÅ assets/js/charts.js
// Gr√°ficos e visualiza√ß√µes do Dashboard SENAI Monitoring

// ===================================
// üé® CONFIGURA√á√ïES DOS GR√ÅFICOS
// ===================================
const CHART_CONFIG = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            position: 'bottom',
            labels: {
                usePointStyle: true,
                padding: 20,
                font: {
                    size: 12,
                    family: 'Inter'
                }
            }
        }
    },
    animation: {
        duration: 750,
        easing: 'easeInOutQuart'
    }
};

// Cores do tema SENAI
const SENAI_COLORS = {
    primary: '#1e40af',
    secondary: '#f97316',
    success: '#22c55e',
    warning: '#eab308',
    danger: '#ef4444',
    info: '#3b82f6',
    purple: '#8b5cf6',
    pink: '#ec4899'
};

// Gradientes
const GRADIENTS = {
    blue: ['#3b82f6', '#1e40af'],
    orange: ['#f97316', '#ea580c'],
    green: ['#22c55e', '#16a34a'],
    purple: ['#8b5cf6', '#7c3aed'],
    pink: ['#ec4899', '#db2777']
};

// ===================================
// üìä VARI√ÅVEIS DOS GR√ÅFICOS
// ===================================
let activityChart = null;
let distributionChart = null;
let healthChart = null;
let performanceChart = null;

// ===================================
// üöÄ INICIALIZA√á√ÉO DOS GR√ÅFICOS
// ===================================
function initializeCharts() {
    console.log('üìä Inicializando gr√°ficos...');

    // Aguardar um pouco para garantir que o DOM est√° pronto
    setTimeout(() => {
        try {
            initActivityChart();
            initDistributionChart();
            console.log('‚úÖ Gr√°ficos inicializados com sucesso');
        } catch (error) {
            console.error('‚ùå Erro ao inicializar gr√°ficos:', error);
        }
    }, 500);
}

// ===================================
// üìà GR√ÅFICO DE ATIVIDADE DOS FUNCION√ÅRIOS
// ===================================
function initActivityChart() {
    const canvas = document.getElementById('activityChart');
    if (!canvas) {
        console.warn('‚ö†Ô∏è Canvas activityChart n√£o encontrado');
        return;
    }

    const ctx = canvas.getContext('2d');

    // Dados mockados para demonstra√ß√£o
    const mockData = generateActivityMockData();

    activityChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: mockData.hours,
            datasets: [{
                label: 'Funcion√°rios Ativos',
                data: mockData.data,
                borderColor: SENAI_COLORS.primary,
                backgroundColor: createGradient(ctx, GRADIENTS.blue),
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: SENAI_COLORS.primary,
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7
            }, {
                label: 'Funcion√°rios Offline',
                data: mockData.offlineData,
                borderColor: SENAI_COLORS.danger,
                backgroundColor: createGradient(ctx, ['#ef4444', '#dc2626'], 0.3),
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: SENAI_COLORS.danger,
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 4
            }]
        },
        options: {
            ...CHART_CONFIG,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 150,
                    grid: {
                        color: '#f3f4f6'
                    },
                    ticks: {
                        font: {
                            size: 11,
                            family: 'Inter'
                        },
                        color: '#6b7280'
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 11,
                            family: 'Inter'
                        },
                        color: '#6b7280'
                    }
                }
            },
            plugins: {
                ...CHART_CONFIG.plugins,
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: SENAI_COLORS.primary,
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: true,
                    callbacks: {
                        title: function (context) {
                            return `Hor√°rio: ${context[0].label}`;
                        },
                        label: function (context) {
                            return `${context.dataset.label}: ${context.raw} funcion√°rios`;
                        }
                    }
                }
            }
        }
    });
}

// ===================================
// üó∫Ô∏è GR√ÅFICO DE DISTRIBUI√á√ÉO POR SETORES (ALINHADO COM API REAL)
// ===================================
function initDistributionChart() {
    const canvas = document.getElementById('zonesChart');
    if (!canvas) {
        console.warn('‚ö†Ô∏è Canvas zonesChart n√£o encontrado');
        return;
    }

    const ctx = canvas.getContext('2d');

    // Dados dos setores (conforme API V2.0 real - sem zonas autom√°ticas)
    const sectorsData = {
        labels: ['Produ√ß√£o', 'Almoxarifado', 'Administrativo', 'Outros'],
        data: [45, 23, 19, 0], // Dados simples baseados em setores
        colors: [SENAI_COLORS.primary, SENAI_COLORS.secondary, SENAI_COLORS.success, SENAI_COLORS.warning]
    };

    distributionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: sectorsData.labels,
            datasets: [{
                data: sectorsData.data,
                backgroundColor: sectorsData.colors,
                borderColor: '#ffffff',
                borderWidth: 3,
                hoverBorderWidth: 4,
                hoverBorderColor: '#ffffff'
            }]
        },
        options: {
            ...CHART_CONFIG,
            cutout: '65%',
            plugins: {
                ...CHART_CONFIG.plugins,
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: SENAI_COLORS.primary,
                    borderWidth: 1,
                    cornerRadius: 8,
                    callbacks: {
                        label: function (context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.raw / total) * 100).toFixed(1);
                            return `${context.label}: ${context.raw} funcion√°rios (${percentage}%)`;
                        }
                    }
                },
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 15,
                        font: {
                            size: 12,
                            family: 'Inter'
                        },
                        generateLabels: function (chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map((label, i) => {
                                    const dataset = data.datasets[0];
                                    const total = dataset.data.reduce((a, b) => a + b, 0);
                                    const value = dataset.data[i];
                                    const percentage = ((value / total) * 100).toFixed(1);

                                    return {
                                        text: `${label} (${percentage}%)`,
                                        fillStyle: dataset.backgroundColor[i],
                                        strokeStyle: dataset.backgroundColor[i],
                                        lineWidth: 2,
                                        pointStyle: 'circle',
                                        hidden: false,
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                }
            }
        }
    });
}

// ===================================
// üíì GR√ÅFICO DE SA√öDE (para se√ß√£o de sa√∫de)
// ===================================
function initHealthChart() {
    const canvas = document.getElementById('healthChart');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');

    healthChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Normal', 'Aten√ß√£o', 'Cr√≠tico'],
            datasets: [{
                label: 'Funcion√°rios por Status de Sa√∫de',
                data: [78, 12, 3],
                backgroundColor: [
                    SENAI_COLORS.success,
                    SENAI_COLORS.warning,
                    SENAI_COLORS.danger
                ],
                borderColor: [
                    SENAI_COLORS.success,
                    SENAI_COLORS.warning,
                    SENAI_COLORS.danger
                ],
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            ...CHART_CONFIG,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: '#f3f4f6'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// ===================================
// ‚ö° GR√ÅFICO DE PERFORMANCE (para relat√≥rios)
// ===================================
function initPerformanceChart() {
    const canvas = document.getElementById('performanceChart');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');

    performanceChart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['Produtividade', 'Seguran√ßa', 'Qualidade', 'Efici√™ncia', 'Colabora√ß√£o'],
            datasets: [{
                label: 'Performance Atual',
                data: [85, 92, 78, 88, 90],
                borderColor: SENAI_COLORS.primary,
                backgroundColor: createGradient(ctx, GRADIENTS.blue, 0.2),
                borderWidth: 2,
                pointBackgroundColor: SENAI_COLORS.primary,
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2
            }]
        },
        options: {
            ...CHART_CONFIG,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        color: '#f3f4f6'
                    },
                    pointLabels: {
                        font: {
                            size: 12,
                            family: 'Inter'
                        }
                    }
                }
            }
        }
    });
}

// ===================================
// üîÑ ATUALIZA√á√ÉO DOS GR√ÅFICOS
// ===================================
function updateCharts() {
    if (!appState.realTimeData) return;

    // Atualizar gr√°fico de atividade
    if (activityChart && appState.realTimeData.activity) {
        updateActivityChart();
    }

    // Atualizar gr√°fico de distribui√ß√£o
    if (distributionChart && appState.realTimeData.sectors) {
        updateDistributionChart();
    }
}

function updateActivityChart() {
    const newData = appState.realTimeData.activity;

    if (activityChart && newData) {
        activityChart.data.labels = newData.hours;
        activityChart.data.datasets[0].data = newData.data;
        activityChart.update('active');
    }
}

function updateDistributionChart() {
    const sectorsData = appState.realTimeData.sectors;

    if (distributionChart && sectorsData) {
        const values = Object.values(sectorsData);
        distributionChart.data.datasets[0].data = values;
        distributionChart.update('active');
    }
}

// ===================================
// üé® UTILIT√ÅRIOS PARA GR√ÅFICOS
// ===================================
function createGradient(ctx, colors, opacity = 0.6) {
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, `${colors[0]}${Math.round(opacity * 255).toString(16).padStart(2, '0')}`);
    gradient.addColorStop(1, `${colors[1]}20`);
    return gradient;
}

function generateActivityMockData() {
    const hours = [];
    const data = [];
    const offlineData = [];

    // Gerar dados das √∫ltimas 24 horas
    for (let i = 23; i >= 0; i--) {
        const hour = new Date();
        hour.setHours(hour.getHours() - i);
        hours.push(hour.getHours().toString().padStart(2, '0') + ':00');

        // Simular padr√£o de atividade (mais ativo durante hor√°rio comercial)
        const currentHour = hour.getHours();
        let baseActivity = 30; // Atividade base

        if (currentHour >= 8 && currentHour <= 18) {
            baseActivity = 80; // Hor√°rio comercial
        } else if (currentHour >= 19 && currentHour <= 22) {
            baseActivity = 50; // Noite
        }

        // Adicionar varia√ß√£o aleat√≥ria
        const activity = baseActivity + Math.floor(Math.random() * 20) - 10;
        const offline = Math.floor(Math.random() * 15) + 5;

        data.push(Math.max(0, activity));
        offlineData.push(offline);
    }

    return { hours, data, offlineData };
}

// ===================================
// üîß CONTROLES DOS GR√ÅFICOS
// ===================================
function toggleChartAnimation() {
    const charts = [activityChart, distributionChart, healthChart, performanceChart];
    charts.forEach(chart => {
        if (chart) {
            chart.options.animation.duration = chart.options.animation.duration > 0 ? 0 : 750;
            chart.update();
        }
    });
}

function exportChart(chartName) {
    let chart;
    switch (chartName) {
        case 'activity': chart = activityChart; break;
        case 'distribution': chart = distributionChart; break;
        case 'health': chart = healthChart; break;
        case 'performance': chart = performanceChart; break;
    }

    if (chart) {
        const url = chart.toBase64Image();
        const link = document.createElement('a');
        link.download = `senai-${chartName}-chart.png`;
        link.href = url;
        link.click();
    }
}

function resetChartZoom(chartName) {
    let chart;
    switch (chartName) {
        case 'activity': chart = activityChart; break;
        case 'distribution': chart = distributionChart; break;
        case 'health': chart = healthChart; break;
        case 'performance': chart = performanceChart; break;
    }

    if (chart && chart.resetZoom) {
        chart.resetZoom();
    }
}

// ===================================
// üéØ CLEANUP E DESTRUI√á√ÉO
// ===================================
function destroyCharts() {
    const charts = [activityChart, distributionChart, healthChart, performanceChart];
    charts.forEach(chart => {
        if (chart) {
            chart.destroy();
        }
    });

    // Reset das vari√°veis
    activityChart = null;
    distributionChart = null;
    healthChart = null;
    performanceChart = null;
}

// ===================================
// üîç DEBUG DOS GR√ÅFICOS
// ===================================
window.chartsDebug = {
    activity: () => activityChart,
    distribution: () => distributionChart,
    health: () => healthChart,
    performance: () => performanceChart,
    update: () => updateCharts(),
    destroy: () => destroyCharts(),
    export: (name) => exportChart(name),
    toggleAnimation: () => toggleChartAnimation()
};

console.log('üìä Charts debug dispon√≠vel via window.chartsDebug');